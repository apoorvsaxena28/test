package com.boa.gendart.dao;

import com.boa.gendart.common.DataSourceLocator;
import com.boa.gendart.procedure.IFFetchBlobStoredProcedure;
import com.boa.gendart.util.StaticDataLoader;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.support.JdbcDaoSupport;
import org.springframework.stereotype.Repository;

import javax.sql.DataSource;
import java.sql.Array;
import java.sql.Connection;
import java.sql.Struct;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Repository
public class IFFBlobFetchDAO extends JdbcDaoSupport {

    private IFFetchBlobStoredProcedure ifFetchBlobStoredProcedure;

    @Autowired
    public void setIFFDS(@Qualifier("iffPrimaryDS") DataSource datasource) {
        setDataSource(datasource);
    }

    @Override
    protected void initDao() {
        this.ifFetchBlobStoredProcedure = new IFFetchBlobStoredProcedure(getJdbcTemplate());
    }

    public Map findIFFBlobs(List<Map> txnKeys) throws Exception {

        Map sectionResultsMap = null;

        if (StaticDataLoader.isPrimaryDBStatus()) {

            Map inputsMap = new HashMap();

            DataSource ds = DataSourceLocator.getPrimaryDatasource("iff");
            try (Connection con = ds.getConnection()) {

                Struct[] structs = new Struct[txnKeys.size()];
                int i = 0;

                for (Map m : txnKeys) {
                    structs[i++] = con.createStruct(
                            "FDS_UDP_PROCEDURES.RUN_ID_TYPE",
                            new Object[]{
                                    Long.parseLong(String.valueOf(m.get("PC_RULE_IN_OUT_LOG_ID")))
                            }
                    );
                }

                Array runIdArray = con.createArrayOf(
                        "FDS_UDP_PROCEDURES.RUN_ID_TABLE",
                        structs
                );

                inputsMap.put("P_RUN_IDS", runIdArray);
                inputsMap.put("P_MAXROW", 50);

                sectionResultsMap = this.ifFetchBlobStoredProcedure.execute(inputsMap);
            }
        }

        return sectionResultsMap;
    }
}