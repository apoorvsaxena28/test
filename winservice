// Service Class
import org.springframework.stereotype.Service;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.HashSet;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class WindowsServiceDiscoveryService {

    // Regex to capture the service name from the 'sc query' command output
    private static final Pattern SERVICE_NAME_PATTERN = Pattern.compile("^SERVICE_NAME: (.+)$", Pattern.MULTILINE);

    /**
     * Executes the 'sc query' command and parses the output to find all service names.
     * @return A Set of unique service names.
     */
    public Set<String> findAllServiceIds() {
        Set<String> serviceNames = new HashSet<>();
        try {
            // Use ProcessBuilder for better control over the process environment
            ProcessBuilder processBuilder = new ProcessBuilder("cmd.exe", "/c", "sc query state= all");
            Process process = processBuilder.start();

            // Read the output of the command
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
                String output = reader.lines().reduce("", (acc, line) -> acc + System.lineSeparator() + line);
                Matcher matcher = SERVICE_NAME_PATTERN.matcher(output);

                while (matcher.find()) {
                    serviceNames.add(matcher.group(1).trim());
                }
            }

            // Wait for the process to complete and check the exit code
            int exitCode = process.waitFor();
            if (exitCode != 0) {
                // Log and handle the error appropriately
                System.err.println("Command exited with non-zero status code: " + exitCode);
            }
        } catch (Exception e) {
            // Log the exception for debugging
            e.printStackTrace();
        }
        return serviceNames;
    }
}
