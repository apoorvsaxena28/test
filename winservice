// Data transfer object for Service information
public record WindowsService(String serviceName, String displayName, Long pid) {}

// Service Class
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.stereotype.Service;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;

@Service
public class WindowsServiceDiscoveryService {

    /**
     * Executes a PowerShell command to get detailed service information.
     * @return A List of WindowsService objects.
     */
    public List<WindowsService> findAllServiceDetails() {
        List<WindowsService> services = new ArrayList<>();
        // PowerShell command to get service details, format as JSON
        String command = "powershell.exe -Command \"Get-CimInstance -ClassName Win32_Service | Select-Object Name, DisplayName, ProcessId | ConvertTo-Json\"";
        
        try {
            ProcessBuilder processBuilder = new ProcessBuilder("cmd.exe", "/c", command);
            Process process = processBuilder.start();

            // Read the JSON output from PowerShell
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
                String output = reader.lines().reduce("", (acc, line) -> acc + System.lineSeparator() + line);
                
                // Use Jackson to parse the JSON array
                ObjectMapper objectMapper = new ObjectMapper();
                services = objectMapper.readValue(output, objectMapper.getTypeFactory().constructCollectionType(List.class, WindowsService.class));
            }

            int exitCode = process.waitFor();
            if (exitCode != 0) {
                System.err.println("PowerShell command exited with non-zero status code: " + exitCode);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return services;
    }
}
